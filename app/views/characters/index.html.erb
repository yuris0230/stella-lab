<div class="page-content">
  <!-- Page header for Characters list -->
  <header class="page-header">
    <h1 class="page-title">Characters</h1>
    <p class="page-lead">
      Browse all characters in the game. You can filter by element and rarity.
    </p>
  </header>

  <!-- Filter bar for basic search & filters -->
  <%= form_with url: characters_path, method: :get, local: true, html: { class: 'filter-bar' } do %>
    <!-- Text search -->
    <div class="filter-search">
      <label class="filter-label" for="q">Search</label>
      <%= text_field_tag :q, @q, id: 'q', class: 'filter-search-input', placeholder: 'Search characters…' %>
    </div>

    <!-- Rarity checkboxes (SR / SSR) -->
    <div class="filter-group">
      <div class="filter-group-label">Rarity</div>
      <div class="filter-pill-group">
        <% rarity_options = { 'SR' => Character.rarities[:sr], 'SSR' => Character.rarities[:ssr] } %>
        <% rarity_options.each do |label, value| %>
          <% id = "rarity_#{label.downcase}" %>
          <%= check_box_tag 'rarities[]',
                            value,
                            Array(params[:rarities]).include?(value.to_s),
                            id: id,
                            class: 'filter-pill-input' %>
          <label class="filter-pill" for="<%= id %>"><%= label %></label>
        <% end %>
      </div>
    </div>

    <!-- Element checkboxes -->
    <div class="filter-group">
      <div class="filter-group-label">Element</div>
      <div class="filter-pill-group">
        <% element_options = {
          'Fire'  => Character.elements[:fire],
          'Water' => Character.elements[:water],
          'Wind'  => Character.elements[:wind],
          'Earth' => Character.elements[:earth],
          'Light' => Character.elements[:light],
          'Dark'  => Character.elements[:dark]
        } %>

        <% element_options.each do |icon, value| %>
          <% id = "element_#{value}" %>
          <%= check_box_tag 'elements[]', value,
                            Array(params[:elements]).include?(value.to_s),
                            id: id, class: 'filter-pill-input' %>
          <label class="filter-pill" for="<%= id %>"><%= icon %></label>
        <% end %>
      </div>
    </div>

    <!-- Submit + Reset buttons -->
    <div class="filter-actions">
      <%= submit_tag 'Apply', class: 'filter-button-primary' %>
      <%= link_to 'Reset', characters_path, class: 'filter-button-reset' %>
    </div>
  <% end %>

  <!-- Result list -->
  <section class="home-section">
    <div class="character-grid">
      <% @characters.each do |ch| %>
        <div class="character-card">
          <!-- detail -->
          <%= link_to character_path(ch), class: "character-card-main" do %>
            <div class="character-card-image-wrap">
              <% if ch.portrait.attached? %>
                <%= image_tag ch.portrait.variant(resize_to_fill: [220, 260]),
                              alt: ch.name,
                              class: "character-card-image" %>
              <% else %>
                <div class="character-card-placeholder">
                  <span><%= ch.name.first.upcase %></span>
                </div>
              <% end %>
            </div>
          <% end %>

          <!-- Footer: ชื่อ, role, และปุ่มหัวใจ -->
          <div class="character-card-footer">
            <div class="character-footer-top">
              <div>
                <div class="character-card-name"><%= ch.name %></div>
                <% if ch.job.present? %>
                  <div class="character-card-role"><%= ch.job.humanize %></div>
                <% end %>
              </div>

              <div class="character-card-like-inline">
                <span class="character-like-count">
                  ♥ <%= ch.likes.count %>
                </span>

                <% if user_signed_in? %>
                  <% liked = ch.likes.exists?(user_id: current_user.id) %>
                  <% heart_label = liked ? "♥" : "♡" %>

                  <%= button_to heart_label,
                                like_path,
                                method: (liked ? :delete : :post),
                                params: {
                                  likeable_type: "Character",
                                  likeable_id: ch.id
                                },
                                class: "like-heart-button",
                                form: { class: "like-heart-form" } %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </section>
</div>